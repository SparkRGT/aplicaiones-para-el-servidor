{
  "name": "recup-flujo-prestamos",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "recup_prestamo.notificacion",
        "options": {}
      },
      "id": "webhook-trigger",
      "name": "Webhook recup_prestamo.notificacion",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [250, 300],
      "webhookId": "recup_prestamo_notificacion"
    },
    {
      "parameters": {
        "jsCode": "// Procesar datos del pr√©stamo\nconst payload = $input.first().json;\n\n// Formatear mensaje para Telegram\nconst estadoEmoji = {\n  'SOLICITADO': 'üìù',\n  'APROBADO': '‚úÖ',\n  'ENTREGADO': 'üìö',\n  'DEVUELTO': 'üîÑ',\n  'VENCIDO': '‚ö†Ô∏è'\n};\n\nconst emoji = estadoEmoji[payload.estadoNuevo] || 'üìã';\n\nconst mensaje = `${emoji} *NOTIFICACI√ìN DE PR√âSTAMO*\n\n` +\n  `üìñ *Libro:* ${payload.libro.recup_titulo}\\n` +\n  `‚úçÔ∏è *Autor:* ${payload.libro.recup_autor}\\n\\n` +\n  `üë§ *Lector:* ${payload.lector.recup_nombreCompleto}\\n` +\n  `üìß *Email:* ${payload.lector.recup_email}\\n` +\n  `üì± *Tel√©fono:* ${payload.lector.recup_telefono}\\n\\n` +\n  `üî¢ *C√≥digo:* ${payload.recup_codigo}\\n` +\n  `üìÖ *Fecha Pr√©stamo:* ${new Date(payload.recup_fechaPrestamo).toLocaleDateString()}\\n` +\n  `üìÖ *Fecha Devoluci√≥n:* ${new Date(payload.recup_fechaDevolucion).toLocaleDateString()}\\n\\n` +\n  `üîÑ *Estado Anterior:* ${payload.estadoAnterior || 'N/A'}\\n` +\n  `‚û°Ô∏è *Estado Nuevo:* ${payload.estadoNuevo}\\n\\n` +\n  `üïê *Fecha del Cambio:* ${new Date(payload.fechaCambio).toLocaleString()}`;\n\nreturn {\n  json: {\n    mensaje,\n    prestamoId: payload.prestamoId,\n    estadoNuevo: payload.estadoNuevo,\n    lectorEmail: payload.lector.recup_email\n  }\n};"
      },
      "id": "format-message",
      "name": "Formatear Mensaje",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [500, 300]
    },
    {
      "parameters": {
        "chatId": "={{ $env.TELEGRAM_CHAT_ID }}",
        "text": "={{ $json.mensaje }}",
        "additionalFields": {
          "parse_mode": "Markdown"
        }
      },
      "id": "telegram-send",
      "name": "Enviar Telegram",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [750, 300],
      "credentials": {
        "telegramApi": {
          "id": "telegram-bot-credential",
          "name": "Telegram Bot API"
        }
      }
    },
    {
      "parameters": {
        "options": {}
      },
      "id": "respond-webhook",
      "name": "Responder Webhook",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [1000, 300]
    }
  ],
  "connections": {
    "Webhook recup_prestamo.notificacion": {
      "main": [
        [
          {
            "node": "Formatear Mensaje",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Formatear Mensaje": {
      "main": [
        [
          {
            "node": "Enviar Telegram",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Enviar Telegram": {
      "main": [
        [
          {
            "node": "Responder Webhook",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": true,
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "recup-flujo-prestamos-v1",
  "meta": {
    "templateCredsSetupCompleted": false,
    "instanceId": "recup-biblioteca-system"
  },
  "tags": [
    {
      "name": "recup-prestamos",
      "createdAt": "2026-02-02T00:00:00.000Z",
      "updatedAt": "2026-02-02T00:00:00.000Z"
    }
  ]
}
